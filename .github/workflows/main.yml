name: M3u Fetch And Modify
on: 
  #schedule: 
    #- cron: 11 */3 * * *
  workflow_dispatch:
  repository_dispatch: #允许外部触发,cf worker定时任务延迟在1分钟以内
    types: [tvcron]
jobs:
  main:
    name: Fetch And Modify
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 允许推送代码
    env:
      ONLY_UPDATE_MIGU: false  # 在这里修改：true 表示只更新 migu_merged.m3u，false 表示更新所有文件
    steps: 
    - name: Checkout code
      uses: actions/checkout@v5
    - name: fetch and modify
      run: |
          pip install requests 

          # 下载并处理migu文件
          wget https://github.com/ioptu/migu_video/raw/refs/heads/main/migu.txt -O migu.m3u  -t 2 --waitretry=5
          python ./scripts/m3u_mergerng.py -i migu.m3u -o mg_m.m3u
          python ./scripts/m3u_merger.py -i mg_m.m3u -o mg_merged.m3u
          python ./scripts/add_channel.py -i mg_merged.m3u -o mg_merged.m3u -a "搜狐剧场,https://hdl-vip-ws.qf.56.com/live/lc_11730.flv"
          
          # 检查是否只更新migu文件
          if [ "$ONLY_UPDATE_MIGU" = "true" ]; then
            echo "只更新migu_merged.m3u文件，跳过其他处理"
          else
            echo "执行完整的更新流程"
            
            #无需频繁更新
            #wget https://raw.githubusercontent.com/lwzlinyi/ziyong/refs/heads/main/live2.m3u -O live2.m3u  -t 2 --waitretry=5
            #python ./scripts/extract.py --input live2.m3u --output t1op.m3u --eoru ',huuc' -n
            #python ./scripts/deduplicate.py -i t1op.m3u -o t1output.m3u

            #无需频繁更新
            #wget http://www.lyyytv.cn/yt/zhibo/1.txt -O 1.txt -t 2 --waitretry=5
            #node ./scripts/txt2m3u.js -i 1.txt -o 1.m3u
            #python ./scripts/extract.py --input 1.m3u --output t2op.m3u --eoru ',lnott' -n
            #python ./scripts/deduplicate.py -i t2op.m3u -o t2output.m3u

            #wget https://github.com/xiaoran29/core/raw/refs/heads/main/output/lite.m3u -O lite.m3u  -t 2 --waitretry=5
            #python ./scripts/extract.py --input lite.m3u --output t3op.m3u --eoru ',qqqtv' -n
            #python ./scripts/m3u_merger.py -i t3op.m3u -o t3op_merged.m3u
            #python ./scripts/url_sorter.py -i t3op_merged.m3u -o t3op_ms.m3u -k 'HD&auth=666858,auth=66615415'

            #临时措施，目标直播源修正了频道名错误后应恢复使用以上注释代码块
            wget https://github.com/xiaoran29/core/raw/refs/heads/main/output/lite.m3u -O lite.m3u  -t 2 --waitretry=5
            python ./scripts/extract.py --input lite.m3u --output t3o.m3u --eoru ',qqqtv' -n
            python ./scripts/url_sorter.py -i t3o.m3u -o t3op.m3u -k "CCTV-5%2B" -ch "CCTV5" -rn "CCTV5+" 
            python ./scripts/m3u_merger.py -i t3op.m3u -o t3op_merged.m3u
            python ./scripts/url_sorter.py -i t3op_merged.m3u -o t3op_ms.m3u -k 'HD&auth=666858,auth=66615415'
            #目标直播源大量缺失qqqtv频道，恢复旧文件 暂停上游更新  #已备份到backup目录，保持跟随上游更新   
            #wget https://github.com/ioptu/IPTV.txt2m3u.player/raw/dcf291331d4e49d18d519e386d11c4278c76ccf2/yp.qqqtv.top.m3u -O qtv.m3u  -t 2 --waitretry=5
            #python ./scripts/url_sorter.py -i qtv.m3u -o qtvop.m3u -k "CCTV-5%2B" -ch "CCTV5" -rn "CCTV5+" 
            #python ./scripts/m3u_merger.py -i qtvop.m3u -o qtvop_merged.m3u
            #python ./scripts/url_sorter.py -i qtvop_merged.m3u -o qtvop_ms.m3u -k 'HD&auth=666858,auth=66615415'
            
            wget https://github.com/xiaoran29/core/raw/refs/heads/main/output/lite.m3u -O lite.m3u  -t 2 --waitretry=5
            python ./scripts/extract.py --input lite.m3u --output t3op2.m3u --eoru ',catvod.com' -n 
            python ./scripts/m3u_merger.py -i t3op2.m3u -o t3op2_merged.m3u
            python ./scripts/url_sorter.py -i t3op2_merged.m3u -o t3op2_ms.m3u -k 'CCTV-' -r

            #无需频繁更新
            #wget https://github.com/hainantv/kk/raw/refs/heads/main/hainan.txt -O hainan.txt  -t 2 --waitretry=5
            #node ./scripts/txt2m3u.js -i hainan.txt -o t4op.m3u
            #python ./scripts/extract.py --input t4op.m3u --output tv4output.m3u --eoru ',php.jdshipin.com/TVOD/iptv.php?id=' -n
            #python ./scripts/m3u_merger.py -i tv4output.m3u -o tv4output_merged.m3u

            python ./scripts/m3u_merger.py -i  t3op2_ms.m3u mg_m.m3u huuc_ipv6.m3u sh.lnott.top.m3u php.jdshipin.com_merged.m3u -o t0op_m.m3u
            python ./scripts/url_sorter.py -i t0op_m.m3u -o t0op_ms.m3u -k "catvod,luuc,miguvideo"
            python ./scripts/url_sorter.py -i t0op_ms.m3u -o t0op_ms.m3u -k "CCTV-" -r

            python ./scripts/url_sorter.py -i t0op_m.m3u -o  ttvop_m.m3u -gr "央视" -rg "央视"
            python ./scripts/url_sorter.py -i ttvop_m.m3u -o  ttvop_m.m3u -gr "卫视" -rg "卫视"
            python ./scripts/m3u_merger.py -i  ttvop_m.m3u -o ttvop_m.m3u 
            python ./scripts/url_sorter.py -i ttvop_m.m3u -o  ttvop_ms.m3u -k "catvod,luuc,miguvideo"
            python ./scripts/url_sorter.py -i ttvop_ms.m3u -o  ttvop_ms.m3u -k "CCTV-" -r
            

          fi
          
    - name: CommitAndPush
      run: |
        # 获取仓库名称（${VAR#*/} 是 Bash 的字符串操作，去掉 owner/ 前缀）
        REPO_NAME="${GITHUB_REPOSITORY#*/}"
        git config --global user.email "github@github.com"
        git config --global user.name "Github Actions"
        
        # 克隆仓库（使用 HTTPS + TOKEN 避免权限问题）
        git clone "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
        cd "$REPO_NAME" || exit 1  # 强制失败时退出

        # 后续操作...
        #mv ./*.m3u ./backup/
        # 移动migu文件（总是执行）
        mv ../mg_merged.m3u ./migu_merged.m3u
        
        # 检查是否只更新migu文件
        if [ "$ONLY_UPDATE_MIGU" != "true" ]; then
          # 移动其他文件（完整更新时执行）
          mv ../t3op.m3u ./yp.qqqtv.top.m3u
          mv ../t3op_ms.m3u  ./yp.qqqtv.top_merged.m3u
          #mv ../qtvop.m3u ./yp.qqqtv.top.m3u
          #mv ../qtvop_ms.m3u ./yp.qqqtv.top_merged.m3u
          #mv ../t1output.m3u ./huuc_ipv6.m3u
          #mv ../t2output.m3u ./sh.lnott.top.m3u
          #mv ../tv4output.m3u ./php.jdshipin.com.m3u
          #mv ../tv4output_merged.m3u ./php.jdshipin.com_merged.m3u
          mv ../t3op2.m3u ./catvod.com.m3u
          mv ../t3op2_ms.m3u ./catvod.com_merged.m3u
          mv ../t0op_ms.m3u ./tv_merged.m3u
          mv ../ttvop_ms.m3u ./ttv_merged.m3u
        fi

        git add .
        if git diff --cached --quiet; then
          echo "No changes to commit."
        else
          git commit -m "Update: $(date +'%Y-%m-%d %H:%M:%S')"
          git push origin main
        fi
