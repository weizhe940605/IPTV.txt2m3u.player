name: M3u Fetch And Modify
on: 
  schedule: 
    - cron: 11 */2 * * *
  workflow_dispatch:
jobs:
  main:
    name: Fetch And Modify
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 允许推送代码
    steps: 
    - name: Checkout code
      uses: actions/checkout@v5
    - name: fetch and modify
      run: |
          pip install requests 


          wget https://github.com/5iClub/migu_video/raw/refs/heads/main/migu.txt -O migu.m3u  -t 2 --waitretry=5
          python ./scripts/m3u_mergerng.py -i migu.m3u -o mg_m.m3u
          python ./scripts/m3u_merger.py -i mg_m.m3u -o mg_merged.m3u
          
          wget https://raw.githubusercontent.com/lwzlinyi/ziyong/refs/heads/main/live2.m3u -O live2.m3u  -t 2 --waitretry=5
          python ./scripts/extract.py --input live2.m3u --output t1op.m3u --eoru ',huuc'
          python ./scripts/deduplicate.py -i t1op.m3u -o t1output.m3u

          wget http://www.lyyytv.cn/yt/zhibo/1.txt -O 1.txt -t 2 --waitretry=5
          node ./scripts/txt2m3u.js -i 1.txt -o 1.m3u
          python ./scripts/extract.py --input 1.m3u --output t2op.m3u --eoru ',lnott'
          python ./scripts/deduplicate.py -i t2op.m3u -o t2output.m3u

          wget https://github.com/xiaoran29/core/raw/refs/heads/main/output/lite.m3u -O lite.m3u  -t 2 --waitretry=5
          python ./scripts/extract.py --input lite.m3u --output t3op.m3u --eoru ',qqqtv'        
          python ./scripts/m3u_merger.py -i t3op.m3u -o t3op_merged.m3u
          python ./scripts/url_sorter.py -i t3op_merged.m3u -o t3op_ms.m3u -k 'HD&auth=666858,auth=66615415'

          wget https://github.com/hainantv/kk/raw/refs/heads/main/hainan.txt -O hainan.txt  -t 2 --waitretry=5
          node ./scripts/txt2m3u.js -i hainan.txt -o t4op.m3u
          python ./scripts/extract.py --input t4op.m3u --output tv4output.m3u --eoru ',php.jdshipin.com/TVOD/iptv.php?id=' 
          python ./scripts/m3u_merger.py -i tv4output.m3u -o tv4output_merged.m3u


          wget https://github.com/ls125781003/tvboxtg/raw/refs/heads/main/%E7%8E%8B%E4%BA%8C%E5%B0%8F/lives/%E5%86%B0%E8%8C%B6.txt -O bc.m3u  -t 2 --waitretry=5
          python ./scripts/extract.py --input bc.m3u --output test.m3u --eandu '上海,sh' 

          
    - name: CommitAndPush
      run: |
        # 获取仓库名称（${VAR#*/} 是 Bash 的字符串操作，去掉 owner/ 前缀）
        REPO_NAME="${GITHUB_REPOSITORY#*/}"
        git config --global user.email "github@github.com"
        git config --global user.name "Github Actions"
        
        # 克隆仓库（使用 HTTPS + TOKEN 避免权限问题）
        git clone "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
        cd "$REPO_NAME" || exit 1  # 强制失败时退出

        # 后续操作...
        mv ../mg_merged.m3u ./migu_merged.m3u
        mv ../t1output.m3u ./huuc_ipv6.m3u
        mv ../t2output.m3u ./sh.lnott.top.m3u
        mv ../t3op.m3u ./yp.qqqtv.top.m3u
        mv ../t3op_ms.m3u  ./yp.qqqtv.top_merged.m3u
        mv ../tv4output.m3u ./php.jdshipin.com.m3u
        mv ../tv4output_merged.m3u ./php.jdshipin.com_merged.m3u
        mv ../test.m3u ./test.m3u


        git add .
        if git diff --cached --quiet; then
          echo "No changes to commit."
        else
          git commit -m "Update: $(date +'%Y-%m-%d %H:%M:%S')"
          git push origin main
        fi
